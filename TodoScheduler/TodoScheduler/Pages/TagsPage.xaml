<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:base="clr-namespace:TodoScheduler.Infrastructure.Base;assembly:TodoScheduler"
             xmlns:behaviors="clr-namespace:TodoScheduler.Infrastructure.Behaviors;assembly:TodoScheduler"
             xmlns:sm="clr-namespace:TodoScheduler.Infrastructure.StateManager;assembly:TodoScheduler"
             xmlns:controls="clr-namespace:TodoScheduler.Controls;assembly:TodoScheduler"
             x:Class="TodoScheduler.Pages.TagsPage"
             x:Name="page"
             Title="Tags">
  <base:BaseContentPage.ToolbarItems>
    <ToolbarItem Icon="refresh.png" Command="{Binding RefreshCommand}"/>
    <ToolbarItem Icon="add_tag.png" Command="{Binding AddNewTagCommand}"/>
  </base:BaseContentPage.ToolbarItems>
  <sm:StateContainer State="{Binding State}">
    <sm:StateCondition State="Normal">
      <ScrollView BackgroundColor="{StaticResource GrayColor}">
        <ListView ItemsSource="{Binding Tags}"
                  x:Name="list"
                  BackgroundColor="{StaticResource GrayColor}"
                  IsPullToRefreshEnabled="True"
                  IsRefreshing="{Binding IsRefresh}"
                  RefreshCommand="{Binding RefreshCommand}"
                  SeparatorVisibility="None"
                  RowHeight="140">
      <ListView.Behaviors>
        <behaviors:EventToCommandBehavior EventName="ItemTapped"
                                          Command="{Binding ItemTappedCommand}"
                                          Converter="{StaticResource ItemTappedConverter}">
        </behaviors:EventToCommandBehavior>
      </ListView.Behaviors>
      <ListView.ItemTemplate>
        <DataTemplate>
          <ViewCell x:Name="cell">
            <Grid BackgroundColor="{StaticResource GrayColor}">
              <Frame HasShadow="True" Padding="0" Margin="0,5"
                     BackgroundColor="{StaticResource WhiteColor}">
                <Grid BackgroundColor="{StaticResource WhiteColor}"
                      VerticalOptions="FillAndExpand"
                      HorizontalOptions="FillAndExpand">
                  <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>  <!--header(description etc)-->
                    <RowDefinition Height="1"/>  <!--separator-->
                    <RowDefinition Height="40"/> <!--buttons-->
                  </Grid.RowDefinitions>
                  <!--header-->
                  <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/> <!--description-->
                      <ColumnDefinition Width="50"/> <!--delete button-->
                    </Grid.ColumnDefinitions>
                    <!--description-->
                    <StackLayout Grid.Column="0" Padding="10">
                      <Label Text="{Binding Title}" FontSize="17"
                             TextColor="{Binding TagColor}"/>
                      <Label Text="{Binding TodoItemsCount, StringFormat='Total items: {0}'}" 
                             Font="Small, Italic"/>
                    </StackLayout>
                    <!--remove button-->
                    <StackLayout Grid.Column="1" Padding="10" VerticalOptions="StartAndExpand"
                                 HorizontalOptions="Center">
                      <controls:ImageButton Source="remove_tag.png"
                                            Command="{Binding RemoveTagCommand}"
                                            BindingContext="{Binding Source={x:Reference list}, Path=BindingContext}"
                                            CommandParameter="{Binding Source={x:Reference cell}, Path=BindingContext}"/>
                    </StackLayout>
                  </Grid>
                  <!--separator-->
                  <controls:Separator Grid.Row="1" BackgroundColor="{StaticResource GrayColor}" Margin="10,0"/>
                  <!--buttons-->
                  <Grid Grid.Row="2" HorizontalOptions="FillAndExpand"
                        VerticalOptions="FillAndExpand" Padding="15,0">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/>
                      <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <controls:ImageButton Grid.Column="0" Source="add_todo.png"
                                          HorizontalOptions="Start"
                                          Command="{Binding AddTodoForTagCommand}"
                                          BindingContext="{Binding Source={x:Reference list}, Path=BindingContext}"
                                          CommandParameter="{Binding Source={x:Reference cell}, Path=BindingContext}"/>

                    <controls:ImageButton Grid.Column="1" Source="detail.png"
                                          HorizontalOptions="End"
                                          Command="{Binding DetailTagCommand}"
                                          BindingContext="{Binding Source={x:Reference list}, Path=BindingContext}"
                                          CommandParameter="{Binding Source={x:Reference cell}, Path=BindingContext}"/>

                  </Grid>
                </Grid>
            </Frame>
            </Grid>
          </ViewCell>
        </DataTemplate>
      </ListView.ItemTemplate>
    </ListView>
  </ScrollView>
    </sm:StateCondition>
    <sm:StateCondition State="Loading">
      <StackLayout HorizontalOptions="Center"
                   VerticalOptions="Center">
        <ActivityIndicator IsRunning="True" IsVisible="True"/>
      </StackLayout>  
    </sm:StateCondition>
    <sm:StateCondition State="NoData">
      <StackLayout HorizontalOptions="Center"
                   VerticalOptions="Center">
        <Label Text="No data"/>
      </StackLayout>  
    </sm:StateCondition>
  </sm:StateContainer>
</base:BaseContentPage>